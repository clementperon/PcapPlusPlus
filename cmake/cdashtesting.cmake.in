set(CTEST_SOURCE_DIRECTORY  "@CMAKE_SOURCE_DIR@")
set(CTEST_BINARY_DIRECTORY  "@CMAKE_BINARY_DIR@")
set(CTEST_CMAKE_GENERATOR   "@CMAKE_GENERATOR@")
set(CTEST_BUILD_NAME        "@BUILDNAME@")
set(CTEST_SITE              "@SITE@")
set(CTEST_OUTPUT_ON_FAILURE ON)

set(MODEL Experimental)
if(${CTEST_SCRIPT_ARG} MATCHES Nightly)
  set(MODEL Nightly)
elseif(${CTEST_SCRIPT_ARG} MATCHES Continuous)
  set(MODEL Continuous)
endif()

set(CTEST_MEMORYCHECK_TYPE "ThreadSanitizer")
ctest_start(${MODEL})
file(WRITE "${CTEST_SCRIPT_DIRECTORY}/bin/CMakeCache.txt" "
CMAKE_CXX_FLAGS=-g -O1 -fsanitize=thread -fno-omit-frame-pointer -fPIC")
ctest_configure()
ctest_build()
ctest_test()
ctest_memcheck()

set(CDASH_TOKEN "$ENV{CTEST_CDASH_AUTH_TOKEN}")
if (NOT "${CDASH_TOKEN}" STREQUAL "")
	ctest_submit(HTTPHEADER "Authorization: Bearer ${CDASH_TOKEN}")
endif()
